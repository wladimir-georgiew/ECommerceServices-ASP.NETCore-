<meta charset="utf-8" />
@using FastServices.Data.Models
@using Microsoft.AspNetCore.Identity
@using FastServices.Common

@model IEnumerable<FastServices.Web.ViewModels.Comments.CommentViewModel>

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@{
    var user = await UserManager.GetUserAsync(this.User);
}

<style>
    .commentSection {
    }

    .vertical-center {
        margin: 0;
        position: absolute;
        top: 50%;
        -ms-transform: translateY(-50%);
        transform: translateY(-50%);
    }
    /*STARS CSS*/
    .rating {
        display: flex;
        flex-direction: row-reverse;
        justify-content: center;
        margin-top: -4em;
    }

        .rating > input {
            display: none
        }

        .rating > label {
            position: relative;
            width: 1em;
            font-size: 6vw;
            color: #FFD600;
            cursor: pointer
        }

            .rating > label::before {
                content: "\2605";
                position: absolute;
                opacity: 0
            }

            .rating > label:hover:before,
            .rating > label:hover ~ label:before {
                opacity: 1 !important
            }

        .rating > input:checked ~ label:before {
            opacity: 1
        }

        .rating:hover > input:checked ~ label:before {
            opacity: 0.4
        }
    /*STARS CSS END*/

    .mt-100 {
        margin-top: 2em
    }

    .mb-100 {
        margin-bottom: 100px
    }

    .card {
        position: relative;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: vertical;
        -webkit-box-direction: normal;
        -ms-flex-direction: column;
        flex-direction: column;
        min-width: 0;
        word-wrap: break-word;
        background-color: #fff;
        background-clip: border-box;
    }

    .card-body {
        -webkit-box-flex: 1;
        -ms-flex: 1 1 auto;
        flex: 1 1 auto;
        padding: 1.25rem
    }

    .card .card-title {
        position: relative;
        font-weight: 600;
        margin-bottom: 10px;
        cursor: text;
    }

    .comment-widgets {
        position: relative;
        margin-bottom: 10px
    }

        .comment-widgets .comment-row {
            border-bottom: 1px solid transparent;
            padding: 14px;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            margin: 10px 0
        }

    .p-2 {
        padding: 0.5rem !important
    }

    .comment-text {
        padding-left: 15px;
        font-family: 'Calibri', sans-serif !important
    }

    .w-100 {
        width: 100% !important
    }

    .m-b-15 {
        margin-bottom: 15px
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.76563rem;
        line-height: 1.5;
        border-radius: 1px
    }

    .btn-cyan {
        color: #fff;
        background-color: #27a9e3;
        border-color: #27a9e3
    }

        .btn-cyan:hover {
            color: #fff;
            background-color: #1a93ca;
            border-color: #198bbe
        }

    .comment-widgets .comment-row:hover {
        background: rgba(0, 0, 0, 0.05)
    }
</style>

<div class="col-lg-8">
    <div style="width:160%" class="card">
        <div class="card-body text-center">
            <h4 class="card-title">Last 5 comments for @ViewData["depName"].ToString().ToLower() department</h4>
        </div>

        <form asp-controller="Departments" asp-action="AddComment">
            <input style="visibility:hidden" name="DepartmentId" value="@Context.Request.Query["id"]" />

            @*@if (ViewContext.HttpContext.Request.Query["error"] == "not-allowed")
            {
                <partial data="@this.TempData["Message"]" name="/Views/Shared/_ErrorPopup.cshtml"/>
            }*@

            @if (this.SignInManager.IsSignedIn(this.User))
            {
                <div class="rating">
                    <input id="Stars" type="text" name="Stars" value="1" />
                    <input type="radio" onclick="getResult()" name="rating" value="5" id="5"><label for="5">☆</label>
                    <input type="radio" onclick="getResult()" name="rating" value="4" id="4"><label for="4">☆</label>
                    <input type="radio" onclick="getResult()" name="rating" value="3" id="3"><label for="3">☆</label>
                    <input type="radio" onclick="getResult()" name="rating" value="2" id="2"><label for="2">☆</label>
                    <input type="radio" onclick="getResult()" name="rating" value="1" id="1"><label for="1">☆</label>
                </div>

                <script>
                    function getResult() {

                        var result = 0;

                        if (document.getElementById('5').checked) {
                            result = document.getElementById('5').value;
                        }
                        else if (document.getElementById('4').checked) {
                            result = document.getElementById('4').value;
                        }
                        else if (document.getElementById('3').checked) {
                            result = document.getElementById('3').value;
                        }
                        else if (document.getElementById('2').checked) {
                            result = document.getElementById('2').value;
                        }
                        else if (document.getElementById('1').checked) {
                            result = document.getElementById('1').value;
                        }

                        document.getElementById("Stars").value = result;
                    }
                </script>

                <div style="text-align:left" asp-validation-summary="All" class="text-danger"></div>


                <div style="text-align:center">
                    <textarea style="width:80%; height:100px" type="text" name="CommentContent"></textarea>
                </div>

                <button style="position:relative; left:45%; top:1em" class="btn btn-cyan" type="submit">Submit</button>
            }
            else
            {
                <h1 style="text-align:center">
                    <a style="color:deepskyblue" asp-area="Identity" asp-controller="Account" asp-action="Login">Sign in</a>
                    to leave a comment
                </h1>
            }
        </form>





        <div class="comment-widgets">
            @foreach (var comment in Model)
            {<!-- Comment Row -->
                <article>
                    <div class="d-flex flex-row comment-row m-t-0 commentSection">
                        <div class="p-2"><img src="@comment.AvatarImgSrc" alt="user" width="50" class="rounded-circle"></div>
                        <div class="comment-text w-75">
                            <h6 class="font-medium">@comment.Name</h6>
                            <h6 style="color:#FFD600">@comment.Stars/5</h6>
                            <span class="m-b-15 d-block">@comment.CommentContent</span>
                            <div class="comment-footer">
                                <span class="text-muted float-right">@comment.CreatedOn</span>
                                @*<button type="button" class="btn btn-cyan btn-sm">Edit</button>*@

                                @if (user?.Id == comment.UserId ||
                        this.User.IsInRole(GlobalConstants.AdministratorRoleName))
                                {
                                    <form asp-controller="Departments" asp-action="DeleteComment" asp-route-departmentId="@comment.DepartmentId" asp-route-commentId="@comment.CommentId" data-ajax="true" data-ajax-success="deleteItem(this)">
                                        <input style="visibility:hidden; position:absolute" id="departmentId" type="text" name="departmentId" value="@comment.DepartmentId" />
                                        <input style="visibility:hidden;  position:absolute" id="commentId" type="text" name="commentId" value="@comment.CommentId" />
                                        <button class="btn btn-danger btn-sm" type="submit">Delete</button>
                                    </form>
                                }
                            </div>
                        </div>
                    </div>
                </article>
            }
        </div> <!-- Card -->

    </div>
</div>

<script>
    function deleteItem(form) {
        $(form).parentsUntil("article").remove();

        $(document).ready(function () {

            // show when page load
            toastr.error('@FastServices.Common.GlobalConstants.DeletedCommentPostMessage');
        });
    }

</script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}